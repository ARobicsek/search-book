generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ─── Contacts ────────────────────────────────────────────────

model Contact {
  id                Int      @id @default(autoincrement())
  name              String
  title             String?
  roleDescription   String?
  companyId         Int?
  company           Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  companyName       String?
  additionalCompanyIds String?  // JSON array: [2, 5, 7] - IDs of additional current companies
  connectedCompanyIds  String?  // JSON array: [2, 5, 7] - IDs of connected companies
  ecosystem         String   @default("RECRUITER") // RECRUITER, ROLODEX, TARGET, INFLUENCER, ACADEMIA, INTRO_SOURCE
  email             String?
  additionalEmails  String?  // JSON array: ["email2@x.com", "email3@x.com"]
  phone             String?
  linkedinUrl       String?
  location          String?
  photoUrl          String?
  photoFile         String?
  status            String   @default("NEW") // NEW, RESEARCHING, CONNECTED, AWAITING_RESPONSE, FOLLOW_UP_NEEDED, LEAD_TO_PURSUE, ON_HOLD, CLOSED
  howConnected      String?
  referredById      Int?
  referredBy        Contact?  @relation("Referrals", fields: [referredById], references: [id], onDelete: SetNull)
  referrals         Contact[] @relation("Referrals")
  mutualConnections String?
  whereFound        String?
  openQuestions     String?
  notes             String?
  personalDetails   String?
  flagged           Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  statusHistory            ContactStatusHistory[]
  tags                     ContactTag[]
  conversations            Conversation[]
  actions                  Action[]
  linksTo                  Link[]
  prepNotes                PrepNote[]
  employmentHistory        EmploymentHistory[]
  relationshipsFrom        Relationship[] @relation("RelFrom")
  relationshipsTo          Relationship[] @relation("RelTo")
  participantInConversations ConversationParticipant[] @relation("ParticipantInConversations")
  discussedInConversations ConversationContact[] @relation("DiscussedInConversations")
  ideaContacts             IdeaContact[]
  actionContacts           ActionContact[] @relation("ActionContacts")
}

// ─── Companies ───────────────────────────────────────────────

model Company {
  id         Int      @id @default(autoincrement())
  name       String
  industry   String?
  size       String?
  website    String?
  hqLocation String?
  notes      String?
  status     String   @default("RESEARCHING") // RESEARCHING, ACTIVE_TARGET, IN_DISCUSSIONS, CONNECTED, ON_HOLD, CLOSED
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  statusHistory            CompanyStatusHistory[]
  contacts                 Contact[]
  tags                     CompanyTag[]
  actions                  Action[]
  links                    Link[]
  discussedInConversations ConversationCompany[]
  employmentHistory        EmploymentHistory[]
  ideaCompanies            IdeaCompany[]
  actionCompanies          ActionCompany[] @relation("ActionCompanies")
  activities               CompanyActivity[]
}

// ─── Company Activities (company-level action log) ──────────

model CompanyActivity {
  id        Int      @id @default(autoincrement())
  companyId Int
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  date      String   // YYYY-MM-DD
  type      String   @default("OTHER") // APPLIED, EMAIL, CALL, MEETING, RESEARCH, FOLLOW_UP, OTHER
  title     String   // Brief summary, e.g. "Applied to Senior PM role"
  notes     String?  // Optional detailed notes (supports markdown)
  createdAt DateTime @default(now())
}

// ─── Status History ─────────────────────────────────────────

model ContactStatusHistory {
  id          Int      @id @default(autoincrement())
  contactId   Int
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  oldStatus   String?
  newStatus   String
  createdAt   DateTime @default(now())
}

model CompanyStatusHistory {
  id          Int      @id @default(autoincrement())
  companyId   Int
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  oldStatus   String?
  newStatus   String
  createdAt   DateTime @default(now())
}

// ─── Employment History ─────────────────────────────────────

model EmploymentHistory {
  id          Int      @id @default(autoincrement())
  contactId   Int
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  companyId   Int?
  company     Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  companyName String?  // Fallback if company doesn't exist in system
  title       String?  // Role at that company
  startDate   String?  // YYYY-MM or YYYY
  endDate     String?  // YYYY-MM or YYYY, null = current
  createdAt   DateTime @default(now())
}

// ─── Tags ────────────────────────────────────────────────────

model Tag {
  id        Int          @id @default(autoincrement())
  name      String       @unique
  contacts  ContactTag[]
  companies CompanyTag[]
}

model ContactTag {
  contactId Int
  tagId     Int
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([contactId, tagId])
}

model CompanyTag {
  companyId Int
  tagId     Int
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([companyId, tagId])
}

// ─── Conversations ───────────────────────────────────────────

model Conversation {
  id            Int      @id @default(autoincrement())
  contactId     Int
  contact       Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  date          String
  datePrecision String   @default("DAY") // DAY, MONTH, QUARTER, YEAR
  type          String   @default("OTHER") // CALL, EMAIL, MEETING, LINKEDIN, COFFEE, EVENT, OTHER
  summary       String?
  notes         String?
  nextSteps     String?
  photoFile     String?
  createdAt     DateTime @default(now())

  actions            Action[]
  participants       ConversationParticipant[] @relation("ConversationParticipants")
  contactsDiscussed  ConversationContact[]
  companiesDiscussed ConversationCompany[]
}

// Junction: contacts who were participants in the conversation
model ConversationParticipant {
  conversationId Int
  conversation   Conversation @relation("ConversationParticipants", fields: [conversationId], references: [id], onDelete: Cascade)
  contactId      Int
  contact        Contact      @relation("ParticipantInConversations", fields: [contactId], references: [id], onDelete: Cascade)

  @@id([conversationId, contactId])
}

// Junction: people discussed in a conversation
model ConversationContact {
  conversationId Int
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  contactId      Int
  contact        Contact      @relation("DiscussedInConversations", fields: [contactId], references: [id], onDelete: Cascade)

  @@id([conversationId, contactId])
}

// Junction: companies discussed in a conversation
model ConversationCompany {
  conversationId Int
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  companyId      Int
  company        Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@id([conversationId, companyId])
}

// ─── Actions ─────────────────────────────────────────────────

model Action {
  id                    Int           @id @default(autoincrement())
  title                 String
  description           String?
  type                  String        @default("OTHER") // EMAIL, CALL, READ, WRITE, RESEARCH, FOLLOW_UP, INTRO, OTHER
  dueDate               String?
  completed             Boolean       @default(false)
  completedDate         String?
  contactId             Int?
  contact               Contact?      @relation(fields: [contactId], references: [id], onDelete: SetNull)
  companyId             Int?
  company               Company?      @relation(fields: [companyId], references: [id], onDelete: SetNull)
  conversationId        Int?
  conversation          Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  priority              String        @default("MEDIUM") // HIGH, MEDIUM, LOW
  recurring             Boolean       @default(false)
  recurringIntervalDays Int?
  recurringEndDate      String?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  links                 Link[]
  actionContacts        ActionContact[]
  actionCompanies       ActionCompany[]
}

// Junction: contacts associated with an action
model ActionContact {
  actionId  Int
  action    Action  @relation(fields: [actionId], references: [id], onDelete: Cascade)
  contactId Int
  contact   Contact @relation("ActionContacts", fields: [contactId], references: [id], onDelete: Cascade)

  @@id([actionId, contactId])
}

// Junction: companies associated with an action
model ActionCompany {
  actionId  Int
  action    Action  @relation(fields: [actionId], references: [id], onDelete: Cascade)
  companyId Int
  company   Company @relation("ActionCompanies", fields: [companyId], references: [id], onDelete: Cascade)

  @@id([actionId, companyId])
}

// ─── Ideas ───────────────────────────────────────────────────

model Idea {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  tags        String?
  createdAt   DateTime @default(now())

  contacts    IdeaContact[]
  companies   IdeaCompany[]
}

// Junction: contacts associated with an idea
model IdeaContact {
  ideaId    Int
  idea      Idea    @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  contactId Int
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@id([ideaId, contactId])
}

// Junction: companies associated with an idea
model IdeaCompany {
  ideaId    Int
  idea      Idea    @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  companyId Int
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@id([ideaId, companyId])
}

// ─── Links ───────────────────────────────────────────────────

model Link {
  id          Int      @id @default(autoincrement())
  url         String
  title       String
  description String?
  contactId   Int?
  contact     Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  companyId   Int?
  company     Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  actionId    Int?
  action      Action?  @relation(fields: [actionId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
}

// ─── Prep Notes ─────────────────────────────────────────────

model PrepNote {
  id        Int      @id @default(autoincrement())
  content   String   // Free text for thoughts, ideas
  url       String?  // Optional URL for document/web links
  urlTitle  String?  // Optional title for the URL
  date      String   // Target date for this prep (YYYY-MM-DD)
  ordering  Int      @default(0)
  contactId Int
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

// ─── Relationships ───────────────────────────────────────────

model Relationship {
  id            Int     @id @default(autoincrement())
  fromContactId Int
  fromContact   Contact @relation("RelFrom", fields: [fromContactId], references: [id], onDelete: Cascade)
  toContactId   Int
  toContact     Contact @relation("RelTo", fields: [toContactId], references: [id], onDelete: Cascade)
  type          String  // REFERRED_BY, WORKS_WITH, KNOWS, INTRODUCED_BY, REPORTS_TO
  notes         String?
}
