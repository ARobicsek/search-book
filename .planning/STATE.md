# SearchBook — State & Decisions

## Key Decisions Made

| Decision | Choice | Date |
|----------|--------|------|
| Interface | Browser-based local web app | 2026-02-02 |
| Tech stack | React+Vite, Express, SQLite/Prisma, shadcn/ui, FullCalendar | 2026-02-02 |
| Data storage | Local SQLite DB, backup to Google Drive | 2026-02-02 |
| Calendar | Standalone in-app (no Google Calendar sync) | 2026-02-02 |
| Companies | Separate entity (not a contact type) | 2026-02-02 |
| Categories | 6 fixed ecosystems + custom freeform tags | 2026-02-02 |
| Contact statuses | NEW, RESEARCHING, CONNECTED, AWAITING_RESPONSE, FOLLOW_UP_NEEDED, LEAD_TO_PURSUE, ON_HOLD, CLOSED | 2026-02-06 |
| Photos | Drag-drop upload (JPG/PNG) + URL paste | 2026-02-02 |
| Date flexibility | Support day, month, or quarter precision for historical entries | 2026-02-02 |
| Recurring tasks | Supported with configurable intervals | 2026-02-02 |
| Relationships | Record now, graph visualization later | 2026-02-02 |
| Data entry | Quick-add palette + structured forms + CSV bulk import | 2026-02-02 |
| Search | By name, role, company, date of contact, keywords, ecosystem, status | 2026-02-02 |
| Methodology | GSD (Get Shit Done) framework | 2026-02-02 |
| OS | Windows | 2026-02-02 |
| Google Drive | User will install Drive for Desktop; backup to synced folder | 2026-02-02 |
| Navigation | Collapsible left sidebar with icons + labels | 2026-02-02 |
| Table library | TanStack Table (with shadcn DataTable recipe) | 2026-02-02 |
| Form layout | Full-page forms with grouped/collapsible sections | 2026-02-02 |
| DB schema timing | All tables created upfront in Phase 1 | 2026-02-02 |
| Folder structure | client/ + server/ at root, root package.json with concurrently | 2026-02-02 |
| Delete behavior | Hard delete (no soft delete) | 2026-02-02 |
| Contact list columns | Name, Title, Company, Ecosystem, Status, Location, Updated (7 cols) | 2026-02-02 |
| Company detail page | Included in Phase 1 scope | 2026-02-02 |
| Dashboard | Daily view (home page), weekly stats deferred to Phase 5 | 2026-02-03 |
| Action list filter | Simple toggle bar (All/Pending/Completed/Overdue) | 2026-02-03 |
| Calendar library | FullCalendar (month + week views, MIT license) | 2026-02-03 |
| Command palette | shadcn Command component (cmdk-based), Ctrl+K hotkey | 2026-02-03 |
| Quick-add Note | Saves to Ideas table | 2026-02-03 |
| Nudge list location | Integrated directly into Dashboard | 2026-02-03 |

## Coach's Guidance Incorporated
- 6 ecosystem types from coaching framework
- Status values aligned with coaching terminology
- "Open Questions" field per contact
- Location/Region field
- "Contacts without a next action" nudge list
- Weekly activity dashboard (outreach by ecosystem)
- Prep sheet view for pre-call preparation
- Follow-up triggers: 7, 14, 30, 90 day intervals

## User Feedback (from testing)
| Feedback | Phase | Notes |
|----------|-------|-------|
| Contact reference fields (e.g. "Who connected us") need combobox: search existing + free-text | 3 | Applies to referredBy and any person-reference field |
| Photo upload needed in contact create/edit form, not just detail page | 3 | Drag-drop or file picker in form |
| Conversation logging is high priority — structured date, people/companies discussed as searchable+free-text fields | 3 | Core to "capture immediately after conversations" philosophy |
| Global search across all documentation (contacts, ideas, conversations) for person/company names | 4 | Cross-entity full-text search |

## User Feedback Session 2 (Phase 3 testing)
| # | Feedback | Resolution |
|---|----------|------------|
| 1 | Photo not displaying; circle too small | Added /photos Vite proxy; changed to 20x20 rounded-lg rectangle |
| 2 | Auto-set status to CONNECTED on conversation log | Conversations API auto-updates NEW→CONNECTED |
| 3 | Desktop icon to launch app | Created SearchBook.vbs + .bat launcher, desktop shortcut |
| 4 | Search+add-new for people/companies discussed | MultiCombobox allowFreeText=true; auto-creates contacts/companies on submit |
| 5 | Multiple actions per conversation | createActions[] array support; UI with add/remove action rows |
| 6 | 'Meet' action type | Added MEET to ActionType |
| 7 | Links in prep sheet and conversation log | Links CRUD API, links section in PrepSheet, links field in conversation dialog |
| 8 | 'Video Call' conversation type | Added VIDEO_CALL to ConversationType |
| 9 | Company search+create combobox | Company field is now Combobox with allowFreeText; auto-creates company on save |
| 10 | Default status = CONNECTED | Changed emptyForm default from NEW to CONNECTED |
| 11 | Progressive disclosure for less-used fields | Collapsible sections for Phone/LinkedIn, How Connected, Research |
| 12 | Personal details free text field | Added personalDetails to Contact model with collapsible section |
| 13 | Remove Needs Attention from Dashboard | Removed nudge list section entirely |

## User Feedback Session 3 (Phase 3 testing continued)
| # | Feedback | Resolution |
|---|----------|------------|
| 14 | Change Chrome tab title to SearchBook | Updated index.html title |
| 15 | Modal shouldn't close on outside click | Added onInteractOutside handler to DialogContent for conversation/relationship dialogs |
| 16 | Add new contacts from 'who connected us' field | Enabled allowFreeText on referredBy Combobox; auto-creates contact on save |
| 17 | Show next step due date on card | Added due date display to action items in conversation cards |
| 18 | Prep sheet needs text notes + doc links | Combined with #24 → PrepNote model with dated entries |
| 19 | Save button at top of contact form | Added save/cancel buttons in header row alongside title |
| 20 | Track company history (X→Y) | Added EmploymentHistory model; "Move to history" button in contact form |
| 21 | Role description field | Added roleDescription field to Contact model; textarea in form, display in detail/prep sheet |
| 22 | Alphabetical sort in comboboxes | Added .sort() to filteredOptions in Combobox and MultiCombobox |
| 23 | Timezone bug (tomorrow shows as today) | Changed toISOString().split('T')[0] to toLocaleDateString('en-CA') for local timezone |
| 24 | Dated prep elements | Created PrepNote model (content, url, urlTitle, date); Prep Notes section in PrepSheet tab |
| 25 | Cloud backup | Noted for Phase 6 (Google Drive backup already in roadmap) |

## User Feedback Session 4 (Phase 3 testing continued)
| # | Feedback | Resolution |
|---|----------|------------|
| 26 | Chrome tab still shows wrong name | Verified index.html title is correct; browser cache issue — user to hard refresh (Ctrl+Shift+R) |
| 27 | Conversation notes field too small | Increased Textarea rows from 3 to 6; widened dialog from sm:max-w-lg to sm:max-w-xl |
| 28 | 500 error on PUT /api/contacts/:id | Fixed: always delete referredByName from payload before API call (was only deleted when creating new referrer) |
| 29 | "How Connected" placeholder wrong | Changed from "How you know them or who introduced you" to "How did you get connected?" |
| 30 | Mutual Connections should be combobox | Converted from Textarea to MultiCombobox with allowFreeText; stores contact names as comma-separated string |

## User Feedback Session 5 (Phase 5 testing)
| # | Feedback | Resolution |
|---|----------|------------|
| 31 | 500 error + manifest syntax error on startup | Fixed: added devOptions to VitePWA; installed missing checkbox component |
| 32 | Company created from contact card should default to CONNECTED | Fixed: pass status: 'CONNECTED' in auto-create |
| 33 | Idea dialog closes on outside click, losing data | Fixed: added onInteractOutside preventDefault |
| 34 | Prep notes date label too verbose | Fixed: changed to "Date" |
| 35 | Remove Open Questions from contact card | Fixed: removed from overview + prep sheet tabs |
| 36 | Log Conversation should default to Video Call | Fixed: changed emptyForm default to VIDEO_CALL |
| 37 | MultiCombobox: can't remove individual items, only "Clear All" | Fixed: added per-item Badge with X button removal |
| 38 | Ideas should support linking people and companies via combobox | Fixed: IdeaContact/IdeaCompany junction tables, MultiCombobox in dialog |
| 39 | Need to see Prep Notes while logging a conversation | Fixed: two-column dialog with prep notes on left when creating |
| 40 | Multiple emails and companies per contact | Fixed: additionalEmails JSON field, dynamic email inputs, EmploymentHistory for multiple companies |

## Blockers
None currently.

## Session Log
| Date | What Happened |
|------|---------------|
| 2026-02-02 | Initial planning session. Defined architecture, data model, features, phases. Wrote PROJECT.md, REQUIREMENTS.md, ROADMAP.md, STATE.md. |
| 2026-02-02 | Phase 1 discuss + plan complete. Decided: sidebar nav, TanStack Table, full-page grouped forms, all tables upfront, client/server monorepo, hard delete, 7-column contact list, company detail in Phase 1. 13-task plan approved. Starting execution. |
| 2026-02-03 | Phase 1 execution: completed T1-T6. Scaffolding, Prisma schema (all tables), Contact/Company CRUD APIs, Tailwind+shadcn/ui setup, app shell with sidebar nav, routing, API utility, shared types. T7-T13 remain. |
| 2026-02-03 | Phase 1 execution: completed T7-T13. Contact list (TanStack Table, 7 sortable columns, ecosystem/status badges), contact create/edit form (4 grouped sections, company dropdown+freetext, validation), contact detail page (all fields, edit/delete with confirmation, future-phase placeholders), company list (6 sortable columns, status badges), company create/edit form (grouped sections, validation), company detail page (info, linked contacts list, edit/delete), toast error handling on all API calls. **Phase 1 complete.** |
| 2026-02-03 | Phase 2 execution: completed all tasks (T1-T12). Action types/enums (ActionType, ActionPriority, Action, Idea interfaces). Action CRUD API with filters (status, contactId, companyId), complete toggle endpoint. 8 sample actions in seed data. Action list page (TanStack Table, filter toggle bar, complete checkbox, badges). Action form (3 sections, query param pre-fill). Action detail page (badges, complete toggle, edit/delete). Dashboard with daily view (overdue/today/upcoming/unscheduled actions, nudge list). Calendar with FullCalendar (month/week views, color-coded by priority). Contact/Company detail pages updated with real actions list. Command palette (Ctrl+K) with quick-add for contacts/actions/notes. Ideas API endpoint. Sidebar and routing updated. Removed old home.tsx. Fixed TypeScript issues with Express route params. **Phase 2 complete.** |
| 2026-02-03 | Phase 3 started: Conversations & Relationships. Completed T1-T5 of 13 tasks. T1: Added ConversationContact and ConversationCompany junction tables to Prisma schema (db push applied). T2: Added Conversation, Relationship types and enums to client types.ts. T3: Created photo upload backend (multer, /api/upload endpoint, static serving at /photos). T4: Added uploadFile method to API utility. T5: Created reusable Combobox and MultiCombobox components (shadcn popover + command). Also installed shadcn tabs component. **Phase 3 in progress (5/13 tasks complete).** |
| 2026-02-03 | Phase 3 feedback fixes: All 13 user feedback items addressed. Photo display fix (proxy + sizing), auto-status CONNECTED, desktop launcher, search+add-new for contacts/companies in conversation log, multiple actions per conversation, Meet action type, Video Call conversation type, links in prep sheet + conversation log, company combobox with auto-create, default status CONNECTED, progressive disclosure (collapsible sections), personal details field, removed Needs Attention from dashboard. Links CRUD API created. Collapsible component installed. **Phase 3 feedback complete.** |
| 2026-02-03 | Phase 3 completed T6-T13. T6: PhotoUpload UI component (drag-drop, click-to-browse, URL paste, preview with remove). T7: Conversations API (CRUD with junction tables for contactsDiscussed/companiesDiscussed, optional follow-up action creation). T8: Relationships API (CRUD, bidirectional contactId filter). T9: Contact detail page refactored to tabs (Overview, Conversations, Relationships, Prep Sheet). T10: Conversation UI (card list + dialog form with date precision, type, summary, notes, nextSteps, multi-select contacts/companies discussed, optional follow-up action). T11: Relationship UI (card list + dialog form with type, direction, contact select, notes). T12: Contact form updated with PhotoUpload component and referredBy Combobox. T13: Prep Sheet tab (last conversation, open questions, pending actions, relationships, key info). Both client and server pass TypeScript checks. **Phase 3 complete.** |
| 2026-02-03 | Phase 3 feedback round 2: All 12 user feedback items (#14-25) addressed. Chrome tab title fixed. Modal outside-click prevented. ReferredBy field now allows adding new contacts. Action due dates shown on cards. Save button added at top of contact form. RoleDescription field added to Contact. Combobox options sorted alphabetically. Timezone bug fixed (local vs UTC). PrepNote model created for dated prep elements with text/links. EmploymentHistory model created for tracking company changes. Item #25 (cloud backup) noted for Phase 6. **Phase 3 feedback round 2 complete.** |
| 2026-02-03 | Phase 3 feedback round 3: 5 user feedback items addressed. (1) Chrome tab title — verified already correct, user needs Ctrl+Shift+R to clear cache. (2) Conversation notes field — increased rows from 3 to 6, dialog widened to max-w-xl. (3) 500 error on contacts PUT — fixed by always deleting referredByName from payload before API call. (4) "How Connected" placeholder — changed to "How did you get connected?". (5) Mutual Connections — converted from Textarea to MultiCombobox with allowFreeText, stores as comma-separated string. **Phase 3 feedback round 3 complete.** |
| 2026-02-04 | Phase 4 started. Completed: (1) Global search+filter on contacts/companies list pages (TanStack Table filtering, ecosystem/status dropdowns). (2) CSV export for contacts. (3) CSV import with column mapping (3-step wizard). (4) Tags CRUD (assign to contacts via badge UI). (5) Ideas full CRUD (list page, dialogs, search). Remaining: date range filter. **Phase 4 ~90% complete.** |
| 2026-02-04 | Phase 4 completed + Phase 5 started. (1) Date range filter for last outreach — server computes lastOutreachDate from most recent conversation, filter by date range with "include never contacted" option, added Last Outreach column to table. **Phase 4 complete.** (2) PWA support — vite-plugin-pwa with manifest, service worker (NetworkFirst for API, CacheFirst for photos), PWA update prompt component, generated placeholder icons. (3) Analytics dashboard — 6 API endpoints (overview, contacts/conversations over time, by ecosystem/status, actions completed), Recharts visualizations (bar/line/pie charts), period toggle (week/month), overview cards. Added Analytics to sidebar. **Phase 5 analytics complete.** |
| 2026-02-04 | Phase 5 completed + feedback fixes. Feedback: (31) Fixed PWA manifest syntax error — added devOptions to VitePWA config. (32) Default company status to CONNECTED when auto-created from contact form. (33) Idea dialog prevents close on outside click. (34) Prep notes date label simplified to "Date". (35) Open Questions removed from contact detail (overview + prep sheet tabs). (36) Added missing shadcn checkbox component. Phase 5 remaining: (1) Recurring action automation — completing a recurring action auto-creates next occurrence with offset dueDate, respects recurringEndDate, toast notifications on all 5 completion call sites. (2) Contact flagging — flagged field on Contact, flag toggle column on contacts table, "Flagged" filter button, batch action toolbar with "Create Action for Flagged" dialog (title/type/priority/dueDate), flags auto-clear after batch creation. (3) Action history log — "Completed Date" column when Completed filter active, server-side sortBy=completedDate support. **Phase 5 complete.** |
| 2026-02-04 | Feedback items (#36-40) + Phase 6 completed. Feedback: (36) Default conversation type VIDEO_CALL. (37) MultiCombobox per-item Badge removal. (38) Ideas linked to contacts/companies via IdeaContact/IdeaCompany junction tables + MultiCombobox. (39) Prep notes shown in conversation dialog (two-column layout). (40) Multiple emails (additionalEmails JSON field, dynamic inputs) + multiple companies (EmploymentHistory with endDate=null shown in header). Phase 6: (1) One-click backup + restore (backup API, Settings page with create/restore). (2) Loading spinners (Loader2) on all pages. (3) Keyboard shortcuts dialog (? key, g+key navigation). (4) Duplicate detection + merge tool (Levenshtein similarity, merge transfers all relations). **Phase 6 complete.** |
| 2026-02-04 | Pre-Phase 7 fixes session. (1) Action form Combobox — replaced Select with searchable Combobox for Contact/Company fields with inline create. (2) Prep Notes yellow background — added bg-yellow-50 to note cards. (3) Prep Notes progressive disclosure — "+Add Prep Note" button expands to form. (4) Relationship modal Combobox — replaced Select with searchable Combobox + inline create. (5) Multiple companies refactor — replaced EmploymentHistory approach with simple additionalCompanyIds JSON array (like emails), add/remove UI with multiple Comboboxes. (6) Actions page search — added globalFilter search across title/description/contact/company. (7) Idea modal inline create — added allowFreeText to MultiCombobox for contacts/companies with auto-create on submit. Database path: `server/dev.db`. **Pre-Phase 7 fixes complete.** |
| 2026-02-05 | Phase 7 started: iPhone PWA Access via Vercel deployment. (1) Quick fix: company separator changed from comma to pipe. (2) Vercel config: created vercel.json with single serverless function approach (bypasses 12-function limit). (3) Express refactor: split into app.ts (exportable) and index.ts (local server). (4) iOS PWA meta tags: added apple-mobile-web-app-capable, status-bar-style, title. (5) Turso support: added @libsql/client and @prisma/adapter-libsql, updated db.ts for conditional Turso/SQLite. (6) Created api/index.ts for Vercel serverless handler. (7) Updated .gitignore for Vercel. Remaining: create Turso database, set up Vercel Blob for photos, deploy to Vercel, test on iPhone. **Phase 7 in progress.** |
| 2026-02-05 | Phase 7 continued + UI fixes. (1) Vercel Blob support — updated upload.ts to use @vercel/blob in production (BLOB_READ_WRITE_TOKEN detection), multer memory storage for serverless. (2) Current/past company indicator — changed additionalCompanyIds from [id] to [{id, isCurrent}] format, "Past" checkbox in contact form, header shows only current companies, past companies shown with "formerly" styling. (3) Search includes past companies — contact list search now includes all company names. (4) Trash icon overflow fix — wrapped Combobox in flex-1 min-w-0 div. All code changes committed. Remaining: create Turso DB, deploy to Vercel, test iPhone PWA. **Phase 7 in progress.** |
| 2026-02-05 | Debug session: App hanging on dashboard. Root cause: `server/.env` had TURSO_DATABASE_URL uncommented, causing db.ts to connect to Turso cloud instead of local SQLite. Turso connection was hanging (not fully configured). Fix: commented out Turso credentials in .env for local dev. **Important:** Keep Turso credentials commented in .env for local development; set them only in Vercel dashboard for production. |
| 2026-02-05 | **Phase 7 deployment complete.** (1) Created Turso database via web dashboard (CLI requires WSL on Windows). (2) Wrote migration script to transfer data from local SQLite to Turso (downgraded @libsql/client to 0.5.6 to avoid migration jobs bug). (3) Fixed TypeScript errors blocking Vercel build (removed unused Legend import, fixed recharts tooltip types, fixed Field component className prop, made api.post data optional, added dueDate to Conversation.actions type). (4) Fixed Vercel build: added `npm install --prefix client && npm install --prefix server` to build:vercel script. (5) Deployed to Vercel, set TURSO_DATABASE_URL and TURSO_AUTH_TOKEN environment variables (must use `printf` not heredoc to avoid trailing newlines). (6) Blob storage auto-enabled. **App live at https://searchbook-three.vercel.app** with all data synced. **Phase 7 complete.** |
| 2026-02-05 | **Post-Phase 7 polish session.** Priority fixes: (1) Date precision in Last Outreach column — server returns `lastOutreachDatePrecision`, client formats as "January 2026" for MONTH, "2026" for YEAR. (2) Prep notes yellow background — changed `bg-muted/30` to `bg-yellow-50` in conversation dialog. (3) Photo display in production — prioritize `photoUrl` over `photoFile`, only show local paths in dev mode via `import.meta.env.DEV`. (4) SPA routing fix — added fallback rewrite in vercel.json for 404 on hard refresh. New features: (5) Document links for Actions — added `actionId` to Link model, links CRUD in action form/detail pages. (6) Links card for Companies — inline add/remove links on company detail page. (7) Default sort by updatedAt — contacts and companies tables now sort most recently updated first. (8) Phase 8 noted in roadmap — Google Drive document search for full-text search across linked documents. **Pending:** Run Turso migration `ALTER TABLE Link ADD COLUMN actionId INTEGER...` before deploying. |
| 2026-02-05 | **Production bug fixes session.** (1) Overdue timezone fix — Server now accepts `today` query param from client to determine overdue actions using user's local timezone instead of server UTC. Dashboard passes local date in API calls. (2) Photos not showing — Confirmed expected behavior: local `/photos/` paths don't work in production. Users must re-upload photos via production site to store them in Vercel Blob. |
| 2026-02-05 | **Mobile UI improvements session.** Comprehensive mobile fixes for iPhone 390px viewport: (1) Layout — reduced main padding to p-3 on mobile, hid Ctrl+K hint on mobile. (2) Dashboard — ActionRow stacks vertically with 44px touch targets. (3) List pages (contacts, companies, actions) — responsive headers/filter bars, column visibility hides non-essential columns on mobile via TanStack Table columnVisibility. (4) Detail pages — headers stack on mobile, scrollable tabs, responsive Edit/Delete buttons. (5) Forms — Save/Cancel buttons full-width on mobile. (6) Calendar — **BUG:** added listPlugin import but package not installed (needs `npm install @fullcalendar/list`). (7) Analytics — stat cards 2-column grid on mobile. (8) Ideas — larger touch targets for edit/delete buttons. **Next session:** Install missing @fullcalendar/list package, then deploy and test on iPhone. |
| 2026-02-06 | **PWA icon + calendar fix session.** (1) Installed @fullcalendar/list package — fixes calendar build error for mobile list view. (2) Created 1980s retro PWA icons (pink/purple gradient with book + magnifying glass) — later replaced with user's existing Windows 95 pixel-art "S" scroll icon (`SearchBook icon.png`). (3) Updated favicon to use pixel-art PNG instead of SVG for consistent branding across browser tabs, desktop shortcut, and mobile PWA. All changes committed and pushed. **Ready for Vercel deploy and iPhone testing. Next session: Phase 8 (Google Drive document search).** |
| 2026-02-06 | **UI fixes + Global Search session.** (1) Fixed scroll arrows on contact card tab bar — removed `overflow-x-auto` from TabsList. (2) Mutual connections auto-create — contacts entered in "Mutual Connections" field now auto-create with status=CONNECTED if name doesn't exist. (3) **Global Search feature** — new `/api/search` endpoint searching across contacts, companies, actions, ideas with related entities; new `/search` page with expandable result cards showing relationships; enhanced command palette with live search results (debounced 300ms); mobile search button in header (44px touch target, opens command palette). |
| 2026-02-06 | **Contact statuses + CSV import session.** (1) Add actions when editing conversations — removed `!editId` restriction, server PUT now creates actions. (2) Contact status updates — renamed WARM_LEAD→LEAD_TO_PURSUE, added RESEARCHING status. (3) Distinct status colors — contacts (slate/blue/green/yellow/orange/pink/gray/red), companies (sky/indigo/violet/emerald/gray/red). (4) Links in Contact profiles — Links card added to Overview tab with add/remove functionality. (5) Enhanced CSV import — supports firstName/lastName columns (auto-combines), auto-creates companies, creates links from linkUrl column, improved header aliases for auto-mapping (LinkedIn Profile, Mobile, City, etc.). |
| 2026-02-06 | **Auto-save extensions + Merge enhancements session.** (1) Auto-save for Ideas form — added useAutoSave hook (1.5s debounce) and SaveStatusIndicator to Ideas dialog in edit mode. (2) Auto-save for Conversation dialog — added useAutoSave hook (2s debounce) to Conversations dialog; actions/links NOT auto-saved. (3) Enhanced duplicate merge — added missing fields (mutualConnections, whereFound, openQuestions, photoUrl, photoFile, flagged). (4) "Keep Both" option for email — merge dialog now allows combining all emails from both contacts; backend deduplicates and stores first as primary, rest as additionalEmails. |
| 2026-02-07 | **Last Outreach fix + Duplicate detection + Links in edit form session.** (1) Fixed Last Outreach column — root cause was default sort (updatedAt desc) showing bulk-imported contacts (no conversations) on first pages; API data was correct but user never saw pages with outreach data. Added server-side `sortBy=lastOutreachDate` + `sortDir` params so clicking the column header sorts across ALL contacts (not just current page). Server fetches all contacts, computes lastOutreachDate, sorts with nulls last, then paginates. (2) Smarter duplicate detection — added `normalizeName()` to strip middle initials (M.), suffixes (J.D., Jr., PhD, etc.) before Levenshtein comparison. "Katie Tucker" vs "Katie M. Tucker" now scores 1.0 instead of 0.80. Also added compound signal: same company + name similarity >0.6 flags duplicates. (3) Links in contact edit form — added Links card to contact-form.tsx with inline add/remove (same pattern as detail page). Edit mode: loads existing links via API. Create mode: stores pending links locally, saves after contact creation. (4) CSV export includes links — export fetches all links, groups by contactId, adds "Links" column with pipe-separated entries. |
| 2026-02-07 | **Duplicate detection performance + Manual merge + Ctrl-K simplification session.** (1) Simplified Ctrl-K command palette — removed Quick Add, Navigate, Contacts, Companies sections; only Global Search remains on initial open; live search results still shown when typing. (2) Manual merge feature — added Combobox-based contact picker UI on duplicates page; select any two contacts and merge with field-by-field selection. (3) "Keep Both" for phone numbers — added phone to MULTI_VALUE_FIELDS; server combines with " | " separator. (4) Duplicate detection performance — multiple iterations to fix Vercel 30s timeout: (a) pre-computed normalized names/tokens, (b) rewrote to inverted-index candidate generation (name tokens + email), (c) removed company/LinkedIn indexes, (d) slimmed DB query to only id/name/email/title/company, (e) increased client timeout from 15s to 30s. (5) Lazy-load merge details — auto-detected and manual merge buttons now both fetch full contact details on demand (not bundled in list response), fixing type mismatch and reducing payload size. Detection uses OR logic: similar name OR same email. |
| 2026-02-08 | **Backup feature session (BLOCKED).** Attempted to make "Create Backup" work in production (Vercel + Turso). All approaches timed out on Vercel's 30s serverless limit: (1) Single endpoint with `$queryRawUnsafe` on `sqlite_master` + all table SELECTs. (2) Same with `Promise.all` parallelization. (3) Split into `/backup/schema` + `/backup/data/:tableName` per-table endpoints with client-side assembly. (4) Single endpoint using `prisma.*.findMany()` for all 16 models via `Promise.all`. The Prisma/libsql adapter has too much overhead in Vercel's cold-start environment. Current code has `/api/backup/export` endpoint (approach 4) that works conceptually but not within 30s. **Next session: rethink backup strategy from scratch** — consider Turso's own export tools, direct libsql client (bypass Prisma), Turso HTTP API from browser, GitHub Actions cron, or incremental table-by-table approach. |
| 2026-02-08 | **Browser-direct Turso backup session.** Implemented browser-direct backup/restore using `@libsql/client/web` to bypass Vercel's 30s timeout entirely. **Production export works** — browser queries Turso directly over HTTPS, 16 sequential SELECTs, JSON downloads. Architecture: (1) `GET /api/backup/credentials` returns Turso URL+token from env vars (404 in local dev). (2) `client/src/lib/backup.ts` — new module with `exportViaTurso()` and `importViaTurso()` using `@libsql/client/web`. (3) Settings page tries browser-direct first, falls back to server-side Prisma for local dev. (4) `POST /api/backup/import` server endpoint for local dev restore with `transformRecords()` for date/boolean conversion. (5) `POST /api/backup/save-local` to auto-save backup JSON to project `backups/` folder. (6) `backups/` added to `.gitignore`. Two bugs remained for next session. |
| 2026-02-08 | **Backup bug fixes session.** Fixed both remaining backup bugs: (1) **Date parsing** — `transformRecords()` now handles all three date formats from Turso: Unix millisecond timestamps (e.g. `1770157191736`), ISO strings with timezone (`"2026-02-06T16:18:17.954+00:00"`), and raw SQLite strings (`"2026-02-08 15:39:27"`). Extracted `toDate()` helper. Local restore from production backup now works. (2) **Save-local path** — replaced fragile `path.resolve(__dirname, '..', '..', '..')` with robust project root detection that tries three candidate paths and verifies each contains `server/` and `client/` subdirectories. (3) **Backups folder** — created `backups/` directory with `.gitkeep` (contents gitignored). (4) **Save reminder UI** — amber banner appears on Settings page after backup download, reminding user to copy the JSON from Downloads into `SearchBook/backups/`. Production save-local silently fails (Vercel read-only filesystem), so manual copy is the workflow. |
